use std::sync::Arc;

use expect_test::expect;
use testutil::eth::EthNode;
use zk_primitives::Element;

use crate::rpc::{mint, rollup_contract, ServerConfig};

use super::usdc_contract;

#[tokio::test(flavor = "multi_thread")]
async fn merkle() {
    let eth_node = EthNode::default().run_and_deploy().await;
    let server =
        super::Server::setup_and_wait(ServerConfig::single_node(false), Arc::clone(&eth_node))
            .await;
    let rollup = rollup_contract(server.rollup_contract_addr, &eth_node).await;
    let usdc = usdc_contract(&rollup, &eth_node).await;

    let (note, eth_mint_tx, tx) = mint(
        &rollup,
        &usdc,
        &server,
        Element::new(1),
        Element::from(100u64),
    );
    eth_mint_tx.await.unwrap();
    tx.await.unwrap();

    let res = server.merkle(&[note.commitment()]).await.unwrap();

    // TODO: the note is now random, so the path will be different each time
    let expected_paths = expect![[r#"
        [
            [
                0x0,
                0x2ba00861b8f1581f5e17d438e323fa2809f58f1a60009dcd05edb1c9c7c833da,
                0xfa0082e09dd9cc2d8a236938f628b668d57f7b6cb72008ac03142111050864c,
                0x15894af6b6c0549fa9cd30128579a2dc0c567ed7cabfb09bff95949341a9ac81,
                0x1196ddacfe831a4c4a002c3287c5d7b7e62f393acc5dfb9a44e8d4e42852c630,
                0x2e7cc44f05afd41946244940e561ae69222c657950e6540cf9a5589ac2665887,
                0x18a8a74c4cf90a653286ff96cb8bc367eb4a45eaadf256e46f5dedcc969afde7,
                0xcf1ec907e066d0522395aba3c93e3b85aed37d1f51d9503a461a33d3d600128,
                0xda004968db5a60e1689936fa00b858b23187fc0702d07c6b439116d8ee6dec8,
                0x181312e20b6687d377125bc687e156dc8a2167502524d4e56164ceda881ed5fb,
                0x2fd86a1ceaea396f5fb3d98d667bf0e3af20e5b00328fdae766024d96fe923f3,
                0x2cd010d45400358310a2806b6e81c732615fb19396106d8cdd429a066ec4c93b,
                0x26a66bd2ee4162c99a4f0b04ff2f23b69d7bd5841f642760aa590c77528bcb79,
                0x2d0e0d42612b3497ab4033be4d8bce8324b48b1b1e7d7eedddc70a43e8a11b53,
                0x29cb3d60d1d9ea510c929bea0dc112781190aefdd8dc938b5d8478b7d04e6f82,
                0x1ef66fa5658e40fec30020d1796a417ee4b81668b49a71318973d23d3822fb0f,
                0x193b047ed90559dd7cb4e85140d7f92422e3c69f90a049e8d0be21bec59c7ad9,
                0xcfcaec39ff6cf9310f45b44abff9f1c8cfbd5428b785592d3ba8626d1c5b467,
                0x26e15d391281e8698157e32a22635c3b8f6ce159fa398ba4c4ecd8c363e358b2,
                0x25ba03a2973fbc88f7b976626e63586b9330b6ddb08a07aa9c577ce3bb1d3f39,
                0x1f98b89c9a0eafbd9dd569f3d8c5d3e0d3da62b6d358214b4b94a70ba317a5b6,
                0x2c7254b5504739b2384f40bd702c9b1d7aa5559a924b38c545206327790fe23b,
                0x1ad2b9d6ed2c042e2e815f9ea51f1417e8df49da4d5935354df37eec8105b173,
                0x8a9dc89f3b17592f0e55d4e1b818ebd876fc8dafdacb28afb54ad97a482a292,
                0x18d5107e17690548b5fc2cd3c2c532f40448ba29166611ed139261125ac95ed8,
                0x34659157a0f40421b20f7d138b79d1c22f6d5ac16b23ca0ab6791ff40de26eb,
                0x2b22abdfce9a96e2c7306ebaf45f64c7e0c2e7738119447776a6aac223565dfa,
                0x63b1ef8cfe229647b0aff38cff254f8c20e21381881a147f6cf977709a44edc,
                0x11686509090e942105341635ed4a2735c8240b491c75a158f9e8ff4f0a89d25f,
                0x93c360a8f834b92f7e5eac996f164a0a05c3ea454b334efa8b7dcfc2603a179,
                0x36724ee92610cbd02258014d4252e5dbf8e55c85f3fca802ab2d33069e560df,
                0x285013a6c0d3d6b7ee02566ebcba866ed801ddcf6eb852522c2b195c3287de7d,
                0x6334f3c5298ad916b6999c5b2404046b52cabed931e6a75008b6792afb1e5b8,
                0x1fc17d9d3b264f123d7619aa30b1bf07772c1ec90ae9ffec87814d5513e917c5,
                0xa7f2ad12d4e7b7b47e26e9ac4c50aeeef3340e9e938a0d63263f7d04dc47965,
                0x14a929f2e9a65f0ee918baa8d2165ebc566a07c704a4918fa57e9f8867e098c6,
                0x21c0e64648ca0af081e4d5aee2284a953411ba83c816b766f5b7ac3a1c5f2ea,
                0x1e60f854fccdf9186e6fdeffe35b1781d72a5e5084c1f9cdacbdf59682b2b6da,
                0x27ee017018f45efbd35d1c13becfccf19930a17ffdeada836308586f7a17652b,
                0x544f3743bc9686e28c6c1c6f7e05d9882befbf4d81c1a9c9d19e4ac04f0c772,
                0x27027b296144ff2f66b259eacc9ae658f54ec80f1e1778e08863976fc1333122,
                0xfe4d2582275a130e303b95758bebe9003985eea6db0aa7a813170f9d44e6c6b,
                0x2b2a56fc63705101358d464dd6f96f6a2f40d0d22929a82a13f38b4e1ef83c5a,
                0x21136a71eb3e0ccad128ed0c5fae4acf435935142cc4fea0cb5ca5245f964c09,
                0x109aa23474c1223413e13d176196f0b448c413df7ea091f20d5acfbe94c2adb2,
                0x24812503a9748360aca77f150d6ada11b3bca7c8eb76a7c045f4455347f569ff,
                0x24e75967390b53e4667ea7b202070f0e9ba1d6e4a24fa98403de9a6c0afd1be4,
                0x1fc5c8ba7bea28dcaea544338a6466600d8bbf3eea093c912168dc4544d33109,
                0x2ff0a633dccfaf90a76262a6c7771a4b7707ada7d11691494bab0bd44332fd78,
                0x140a69600cfe5daca43117a5915001b474e9be63f8654a745d7e993e5a24667d,
                0x19ef5205ba4137f9a5ed1d653c485f020d583f5adf5f82ffb1accbff613dedad,
                0xe99a2b688ce12dda9a54d7f46294409528b6c2465dd115e9b7edbbfbce6885e,
                0x159b0b17f684742dc49112891bb04d2ec062c68985bd3c2bfdd9b4d008f4092a,
                0x1f94545a8c4c82da4c5faef5a8bd37e5b767d5c758f3cf2c82a671cad380e80d,
                0x1ae026e0eb3eb3a299c4d6d4b93ab200dd183d951d088c6b73aae56693073e16,
                0xda75df3d02f700a29702d2d867e8152106e15a6b3248f406d90dcbce9e03418,
                0xa58a88c183eb1f7cb645758052d439d6264fd212a0e8aaa49dcec034a641c05,
                0x2984944ab07ac291118becffefd8dde8da228ddf99057060e402ee82cf68d2f7,
                0x24508e620942303909250d9c9fc529374f64963448da76cfc8475c2c425faab4,
                0x507c07e3bf4b56fcee9aa982dddfbe440e02ea3beb0cb8a9ae95ddfda5fbbde,
                0xe5592d32d17e603a77406fa21672096996fe7f54f394efef7de7702a13f6bba,
                0x2deb5197b1d60ba97dfc37ec3015411da21c4d77dd9ba013f6d43fe4ef28fd19,
                0x25b425103cbf4d26b7da0388c00f9800c1c54d4cc92155cee9326394b91834a7,
                0x2b2dbad7e25fe587c8ecb97565c4bd9e0a40c4961a56338031cd8d915f893e90,
                0x27b6938eb53bcebe08152e94567c23a2b83cf6fcebb86d046bf199d015c169db,
                0x9012b9bb4d4c0a6780f1c1e28c1a96cf89c379e11eac30bc771e79bbfcc053,
                0x252bf1ab57061be6cefaaf2aa7ddd6ec2e835388e40c7053602103e1b783c322,
                0x173dfc638518e03edd94a5b486cec75b9aa6069b45b798e4b400fe18f6979cd9,
                0x11f0842a361399af7446e5745e3fb6495883bfd2356a9139911bc444a657d0fb,
                0x1c398263a2ed1b23d33d880184f388223711b7df30f87dda37bb084f91f53698,
                0x2afdcc3a40cccedb8a98e0b1196ee9f63f181f87a551eb44d3d50189b7ffee6c,
                0x17082b729fca0c048af719f83d26767cbb44eead9619d42f44741ec81c3d8a59,
                0x5f1be7515c6d34d4598a1bb17e8e7fafe5c3a99c1425f0eefb9e0fedef63d5a,
                0x5b5765901c85a9da1c3aae8d119866701d69f2382e9c4aa304c9bbc57ecd0af,
                0x27a3b0457254c48693d271502fdea91d33a3b89cbb1d22935e73969562187efe,
                0xdcea5250a826f3f5acded4b85c74551f5b326fdf9c2ef91bf2f5ecc410f4ef8,
                0x1f379e6864a284f383987c53f943226ed9a9def9df9c2e1281f3038db8b73069,
                0xcaa4d9ddf67f8e978965105dc4c294e1558f5be96a5ab20abee26f06a86b878,
                0x1db72ce81df8fdb4aa7e66eaad248dacb30de46e3fd86bcb9dffc342b0b24617,
                0x2314cdb07373f9a1fd7ded5b9ea565de4505b41aa3d5156958a923ea2e1923ac,
                0x97d34ba4f29d89e80d542735f3bc99bfa93c5966d54c88ee2802fbe50c97c58,
                0x12533b89ca25234e4dea018caa44f300ce713b106e654cfd4ea679c5412e7959,
                0x2884459a3ffe9ab537b7f5ec5a86f1793e4f028d8bab3cdf2a400907d3ed96f9,
                0x1394f07051dddb186e9182b095121087855f242cf11334f245a704e42a4183ff,
                0x22955f8513585f0fedf06ed81b534223ac5fa5a992bc78a761c2087a5ac7baf2,
                0x2f8301832bde89a531681692b8e6f0bf136e939b9b8c03e8d24b77fa624ddfb8,
                0x118e5c94e59a2cd73d3b00c4c4483fccbdc42f070f246af0fc0a86eaa51fbf99,
                0x267b0901de64e0220079c220f161c51e244c53c3279390140774b7b5bc574e40,
                0x214b939514396f2ca90881b1f921f4ff3b31a16852308571dc8077fa1eb37656,
                0x26d48477fc326e88f1134913143fae780d71de284652660add809d39866509e0,
                0x1145c8fd39f3456b393b71e8611d5fad9125947322284f8548309be82531609b,
                0x2086513dd7eb6578f2aba16707468de7d16ad760fe528331c0e96bd2c4a4036c,
                0x13c570d595c0fde0070d159223092afa5588b01a87a75844adbf4a110514fd2b,
                0x27c8bcdc4210198f4e29c8f9a4b13dc0aa3c00a9107e30f4419a16b0cb4d5366,
                0x2629bd6dae28951476867adbd259179f48686e0cde662b59bff836c8b2d6831f,
                0x5a7c99dc95d6d4e9d46236adc2deedc67b678b67336ccf783a53b044bfcf5f1,
                0x36510786765e76b1c7fa376ceb48c82a4d1ddcf263b7dd82aa93b90ef4fa78d,
                0x1f53f9d04b27c91342057aa34f15969b2c641c95892fae689a39c1957fccb530,
                0x125ee4de8d7089d8261d33831f0e4325766de85caa77791cd39a3a908aab2c17,
                0x194c4130d3f1b4772b96a30272d79da42df1292d248374c0806ea5d199af9746,
                0xca3cb766448934cd89fe8a1631727d97d8019521f51782495dcd169968c8337,
                0x35d951b1d12f5843439a0721b580af43300b06e7de281774d4c8c9f182534c9,
                0x2bb501e9511bb182edad8dd8806a6a294586673a0c72d4a1269704d729cc3357,
                0x2aa87225c3d169c5137ec4a7fd1873961db3844aae14f9a3a2078a27c35c5038,
                0x256f32fe2edf48dfe279cb3b726351a2d4d365b577c4470ec44f88eb7c1242cc,
                0x1f6225529eb00cfd73675e721ea058be52176deab58c64795777739e0cee6cf8,
                0x2e693346afd5d191e5dbfbba4cdfb0d9bc53c797deea50d55cb5f7d13e60fdb8,
                0x2c6c7a27f0c2a0de21fa33a0e0f069be431529271bdf0da2ffce52a28ae0235a,
                0x2f90bd167db8b47ae2d0ea7cc70543e78591c007da07072e9f95a29b54a3991c,
                0x10b25567ba36f0abb42f536e9a6fb5844f9f5010cff1c8487eba4f6c540c0064,
                0x2276bc9b659de721f352a0442febbea9026aa81c1c3f115061ebbbadf37d7683,
                0xedd0555c6ecf3a7c1e0bacb1207f9daef31c1679134bf302cca22a8c1cc54,
                0x218dcea0df356a2f081351f450a7f0962369b4e648b91200972a5835e4a06503,
                0x1d69b9822fe5728269b97d7a03c999a9fbdbc98920f314e9a41252f5ef2fb5f7,
                0x152a306eb8a4dc149c0e4452dfeab442b90c7eb7a9a930ac3bd38fb0c7a1b833,
                0x15e401b95e184dc3e6c0e1f2286f49f4359b80b9b96eb8d5a9d19d5ee3092146,
                0x2cb80795764b18c4b627c9232c1b2dafbf0ae4baeee1c5c2e6eceb3b30c36555,
                0x294d52725db793d6a2dcf07ecbde9f02b056028d2ee0e11f408cbe0ef234b194,
                0x16df97d34e665d9cb326e39406aff9a0b39f17486749911bfba484770e142cd5,
                0x1eb4c97ca54d4b1adbe2fcdad6c5fdf9a38f1bad81096ef6777e4361016676ad,
                0x7a308ef1477c1e390b8b214e8ca80a7977cf2be687d67cb349fc82ebdb87b31,
                0x2527942088d4ba989eeacbd70a6acd4ed3cdee752363ac4ce3833107acd2d8c3,
                0x189a361042b61e7110848dff866a6a4a29ef815e609e3ffbc33183e1b6154fdd,
                0x2cd0bd86569a39970ad6bf2da3224582e4286180f3165a800e1fe3325960783,
                0xf34bf67ad006a684438b07434e91a3c17d9ac96ea1c71a6275e193a43f0d7,
                0x78d0d3c786f837a3d8b9efff48842213f1d219d04786e6eee2abee305cc86af,
                0x92cbb658b1ecd01d9f1ee20fe6a68a5f496f42ace98fd2121c04b378921decb,
                0x1ee266caa678ef7fea4aab420b5aa7475c7b68fe880ccc7c86e810126eb6d1cd,
                0x143b87b510452a62a2e51b9871053decf891b70061b1a79f2ae8f87f37b8acf8,
                0x1fb5320ee24d0fbcf175aa684e62696ddb6f223f871d695826a36361add1661d,
                0x1c34c61be4ced83bf40a0bee9b29d7e6e9b3d1410373a2a510270aafa007088,
                0x1aa855b00ced895b2184fb178f1cf5f44f8f88def97c8fce964df15993116183,
                0x1086a9dd3f295f3f01dcd830e3aa0b62645362426a1dda0eabc74e50372b0a52,
                0xb2109c29b79aa99ba8d442dc6474f6d84120028729b6b3d176d0dcf3a1604f6,
                0x7a88f9504ba43e4ce71340c31b5af809d1f9b6f1e9f4d0f9768248c5d7dd088,
                0x22c3e71fab692ae8783769d2ea3888d6fe1d2b023a9dc76f805c9b23bff2e05f,
                0x1dd9b20d0c4daa00a94fa36608951270bdc155bc4f8324c90146771f088ea143,
                0x15749bb855186a554c3e3622be72a779662eb930659ccf28ed248b0c86dc7055,
                0x252fd9f88628078919388aac15a0d82c782ae32c86132f3bd9b4958729b14136,
                0x17d6be2861eded7c6c96c5ffb8aacc7c4c0cc7a3a5127aaf0dbe96e2251add7f,
                0x6e7ac72836cfd43a812a953a4bea6ee4fcb727e55d43c546855aa38382f312a,
                0x27dfcd4ffd0d6973a06d34be17ba029cc8a6459d8d12be848683d2e062750495,
                0x5010920284b5fcbb77cf4cdfb7a025d1fda2419901ee2d1030fbe758cbe723,
                0x1e41a2afbbe0f7fad4bf11cee21748817a5102e57937511eac918fc6c81568db,
                0x2b2b02f42458e2c1444ad79c4c227da347dc22db00c47dc2a0336ef7ef77478a,
                0x467b1d559d17f600f8476b79bbc44c10efa14603b441d68580f8595426d9e04,
                0x1fc9e2d15bb823ca4be72512f612e6276669cb1c6b76326c32b6e9000c2eeb54,
                0x1f45dcfc01d7e8e186d9fda3c70915d548584bc9d4f2d5c8de85f90947e3ea0a,
                0xff71f6ef2c10f43103eedb6755394555afb2aab7742a66284c451a5523ed445,
                0xc2c279fba7dd01bc126ecd1ff474b41a16e98459347225606d750b1a644c849,
                0x1cd4c5ec22ccb66acf72ab5b42f9f0009e850c56f73b348f35e17011bbf6daf,
                0xe030f83a4f043ed6fd8afb9880b04ed0a12da734c814412c687c0baa9cf842d,
                0xd154640cac2aae058c07b17d7d410c2ab05a1f556e2775f345d1f6f666d864a,
                0xea35bedb3fdb789063d7b0b3eba2d0fc783e0638c15d6f54587af8221158e8f,
                0x21111d6c57bddb775be680be28720e07eca3aec542667574e2d4caf43284d759,
                0x26357c4e2253a07f6e072b1126e3ba2d2bbbf82514ef8d7a43a1da727afcca1d,
                0x77667291e6c8ad34ac18971ca6dbcffd78f9caaf74ef2cdac367b1a12bfa4c0,
                0x2a1516069c40654857ac5183d347e322fd110d06abe6c9ad9a08b9f97ce62a32,
                0x2b78671c0ad73e9c5a5a22ff38cd1b5dd6f89ee35290a77ab02081846116e17,
                0x1729f54054d00d17bb46d4afb4446f4ae32ca87f4a768d1f1ffcb0117281d0b8,
            ],
        ]
    "#]];
    expected_paths.assert_debug_eq(&res.paths);
}
